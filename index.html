<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albion Market Flipper</title>
    <script>
<script>
    async function fetchMarketData() {
        let itemId = document.getElementById("itemInput").value.trim();
        itemId = itemId.replace(/ /g, "_"); // ‚úÖ √énlocuim spa»õiile cu "_"

        if (!itemId) {
            alert("‚ö†Ô∏è Please enter an item ID.");
            return;
        }

        const locations = ["Bridgewatch", "Martlock", "Lymhurst", "Thetford", "Fort Sterling"];
        const taxRate = document.getElementById("taxCheckbox").checked ? 0.04 : 0.08;
        const setupFee = 0.025;

        const url = `https://europe.albion-online-data.com/api/v2/stats/prices/${itemId}.json?locations=${locations.join(",")}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();

            console.log("üîç API Response:", data); // ‚úÖ DEBUGGING

            if (data.length === 0) {
                alert("‚ö†Ô∏è No market data found. Try another item.");
                return;
            }

            let minSell = Infinity, maxSell = 0;
            let minCity = "N/A", maxCity = "N/A";
            let marketData = [];

            locations.forEach(city => {
                const cityData = data.filter(d => d.city === city);
                const sellOrders = cityData.filter(d => d.sell_price_min > 0);

                if (sellOrders.length > 0) {
                    const cityMinSell = Math.min(...sellOrders.map(d => d.sell_price_min));

                    if (cityMinSell < minSell) {
                        minSell = cityMinSell;
                        minCity = city;
                    }

                    if (cityMinSell > maxSell) {
                        maxSell = cityMinSell;
                        maxCity = city;
                    }

                    marketData.push({ city, sellOrder: cityMinSell });
                } else {
                    marketData.push({ city, sellOrder: "N/A" });
                }
            });

            if (maxSell > minSell) {
                const sellAfterSetup = maxSell * (1 - setupFee);
                const finalSellPrice = sellAfterSetup * (1 - taxRate);
                const profit = (finalSellPrice - minSell).toFixed(2);

                displayData(marketData, profit, minCity, minSell, maxCity, maxSell, taxRate, setupFee);
            } else {
                displayData(marketData, "N/A", minCity, minSell, maxCity, maxSell, taxRate, setupFee);
            }

        } catch (error) {
            console.error("‚ùå Error fetching data:", error);
            alert("‚ö†Ô∏è Failed to fetch data. Check the item ID and try again.");
        }
    }
    </script>
</head>
<body>
    <h1>Albion Market Flipper</h1>
    
    <label for="itemInput">Enter Item ID:</label>
    <input type="text" id="itemInput" placeholder="e.g., T4_BAG, T6_CAPE">
    <br><br>

    <input type="checkbox" id="taxCheckbox"> 
    <label for="taxCheckbox">Use 4% tax (otherwise 8%)</label>
    <br><br>

    <button onclick="fetchMarketData()">Get Prices</button>
    
    <table border="1" id="marketTable"></table>
</body>
</html>
