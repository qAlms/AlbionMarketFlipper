<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albion Market Flipper</title>
    <script>
        async function fetchMarketData() {
            const itemId = document.getElementById("itemInput").value;
            const locations = ["Bridgewatch", "Martlock", "Lymhurst", "Thetford", "Fort Sterling"];
            const taxRate = document.getElementById("taxCheckbox").checked ? 0.04 : 0.08;

            if (!itemId) {
                alert("Please enter an item ID.");
                return;
            }
            
            const url = `https://europe.albion-online-data.com/api/v2/stats/prices/${itemId}.json?locations=${locations.join(",")}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                
                let minSell = Infinity, maxSell = 0;
                let minCity = "N/A", maxCity = "N/A";
                let marketData = [];

                locations.forEach(city => {
                    const cityData = data.filter(d => d.city === city);
                    const sellOrders = cityData.filter(d => d.sell_price_min > 0);
                    
                    if (sellOrders.length > 0) {
                        const cityMinSell = Math.min(...sellOrders.map(d => d.sell_price_min));

                        if (cityMinSell < minSell) {
                            minSell = cityMinSell;
                            minCity = city;
                        }

                        if (cityMinSell > maxSell) {
                            maxSell = cityMinSell;
                            maxCity = city;
                        }

                        marketData.push({ city, sellOrder: cityMinSell });
                    } else {
                        marketData.push({ city, sellOrder: "N/A" });
                    }
                });

                if (maxSell > minSell) {
                    const profit = ((maxSell * (1 - taxRate)) - minSell).toFixed(2);
                    displayData(marketData, profit, minCity, minSell, maxCity, maxSell, taxRate);
                } else {
                    displayData(marketData, "N/A", minCity, minSell, maxCity, maxSell, taxRate);
                }

            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Failed to fetch data. Check the item ID and try again.");
            }
        }
        
        function displayData(data, profit, minCity, minSell, maxCity, maxSell, taxRate) {
            const table = document.getElementById("marketTable");
            table.innerHTML = "<tr><th>City</th><th>Sell Order</th></tr>";
            data.forEach(row => {
                table.innerHTML += `<tr><td>${row.city}</td><td>${row.sellOrder}</td></tr>`;
            });

            if (profit !== "N/A" && minCity !== maxCity) {
                table.innerHTML += `<tr><th colspan="2">Best Transport Opportunity</th></tr>`;
                table.innerHTML += `<tr><td>Buy From</td><td>${minCity} (${minSell})</td></tr>`;
                table.innerHTML += `<tr><td>Sell To</td><td>${maxCity} (${maxSell})</td></tr>`;
                table.innerHTML += `<tr><td>Applied Tax</td><td>${(taxRate * 100).toFixed(0)}%</td></tr>`;
                table.innerHTML += `<tr><td>Profit</td><td>${profit}</td></tr>`;
            } else {
                table.innerHTML += `<tr><td colspan="2">No profitable transport found</td></tr>`;
            }
        }
    </script>
</head>
<body>
    <h1>Albion Market Flipper</h1>
    <label for="itemInput">Enter Item ID:</label>
    <input type="text" id="itemInput" placeholder="e.g., T4_BAG">
    <br><br>
    
    <label for="taxCheckbox">Use 4% tax (otherwise 8%)</label>
    <input type="checkbox" id="taxCheckbox">
    <br><br>

    <button onclick="fetchMarketData()">Get Prices</button>
    <table border="1" id="marketTable"></table>
</body>
</html>
